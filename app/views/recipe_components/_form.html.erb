<% products_json = available_products.map { |p| { id: p.id, name: p.name } }.to_json %>
<% subrecipes_json = available_subrecipes.map { |r| { id: r.id, name: r.name } }.to_json %>

<div id="component_form_<%= recipe.id %>"
     data-controller="unified-search"
     data-unified-search-products-value="<%= products_json %>"
     data-unified-search-subrecipes-value="<%= subrecipes_json %>">

  <% if component.errors.any? %>
    <div class="alert alert-danger mb-3">
      <% component.errors.full_messages.each do |msg| %>
        <div><i class="bi bi-x-circle"></i> <%= msg %></div>
      <% end %>
    </div>
  <% end %>

  <%= form_with url: recipe_recipe_components_path(recipe),
                scope: :recipe_component,
                data: { turbo_stream: true } do |f| %>

    <%# Recherche unifiée produits + sous-recettes %>
    <div class="input-group input-group-sm mb-2">
      <input type="text"
             class="form-control"
             placeholder="Rechercher un produit ou une sous-recette..."
             data-unified-search-target="searchInput"
             data-action="input->unified-search#search">
      <span class="input-group-text" data-unified-search-target="selectedDisplay">
        Aucune sélection
      </span>
      <button type="button" class="btn btn-outline-secondary btn-sm"
              data-action="click->unified-search#clear">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <ul class="list-group list-group-flush overflow-auto mb-3"
        style="max-height: 200px;"
        data-unified-search-target="resultsList">
    </ul>

    <input type="hidden"
           name="recipe_component[component_id]"
           data-unified-search-target="componentId">
    <input type="hidden"
           name="recipe_component[component_type]"
           data-unified-search-target="componentType">

    <div class="row g-2 align-items-end">
      <div class="col-md-2">
        <%= f.label :quantity, "Quantité", class: "form-label" %>
        <%= f.number_field :quantity,
              step: "0.001", min: "0.001",
              placeholder: "Quantité",
              class: "form-control form-control-sm" %>
      </div>

      <div class="col-md-2">
        <%= f.label :quantity_unit, "Unité", class: "form-label" %>
        <%= f.select :quantity_unit,
              Units::VALID_UNITS,
              { include_blank: false },
              { class: "form-select form-select-sm" } %>
      </div>

      <div class="col-md-auto">
        <%= f.submit "Ajouter",
              class: "btn btn-sm btn-primary",
              disabled: true,
              data: { unified_search_target: "submitBtn" } %>
      </div>
    </div>
  <% end %>
</div>
