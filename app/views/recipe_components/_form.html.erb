<% products_json = available_products.map { |p| { id: p.id, name: p.name } }.to_json %>
<% subrecipes_json = available_subrecipes.map { |r| { id: r.id, name: r.name } }.to_json %>

<div id="component_form_<%= recipe.id %>"
     data-controller="component-type"
     data-component-type-products-value="<%= products_json %>"
     data-component-type-subrecipes-value="<%= subrecipes_json %>">

  <% if component.errors.any? %>
    <div class="alert alert-danger mb-3">
      <% component.errors.full_messages.each do |msg| %>
        <div><i class="bi bi-x-circle"></i> <%= msg %></div>
      <% end %>
    </div>
  <% end %>

  <%= form_with url: recipe_recipe_components_path(recipe),
                scope: :recipe_component,
                data: { turbo_stream: true } do |f| %>
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <%= f.label :component_type, "Type", class: "form-label" %>
        <%= f.select :component_type,
              [["Produit", "Product"], ["Sous-recette", "Recipe"]],
              { include_blank: "-- Type --" },
              { class: "form-select form-select-sm",
                data: { component_type_target: "typeSelect",
                        action: "change->component-type#toggleType" } } %>
      </div>
    </div>

    <input type="hidden"
           name="recipe_component[component_id]"
           data-component-type-target="componentId">

    <%# Bloc recherche — caché tant qu'aucun type n'est sélectionné %>
    <div class="d-none mt-2" data-component-type-target="searchWrapper">
      <div class="input-group input-group-sm mb-2">
        <input type="text"
               class="form-control"
               placeholder="Rechercher..."
               data-component-type-target="searchInput"
               data-action="input->component-type#search">
        <span class="input-group-text" data-component-type-target="selectedDisplay">
          Aucune sélection
        </span>
      </div>
      <ul class="list-group list-group-flush overflow-auto"
          style="max-height: 200px;"
          data-component-type-target="resultsList">
      </ul>
    </div>

    <div class="row g-2 align-items-end mt-2">
      <div class="col-md-2">
        <%= f.label :quantity, "Quantité", class: "form-label" %>
        <%= f.number_field :quantity,
              step: "0.001", min: "0.001",
              placeholder: "Quantité",
              class: "form-control form-control-sm" %>
      </div>

      <div class="col-md-2">
        <%= f.label :quantity_unit, "Unité", class: "form-label" %>
        <%= f.select :quantity_unit,
              Units::VALID_UNITS,
              { include_blank: false },
              { class: "form-select form-select-sm" } %>
      </div>

      <div class="col-md-auto">
        <%= f.submit "Ajouter",
              class: "btn btn-sm btn-primary",
              disabled: true,
              data: { component_type_target: "submitBtn" } %>
      </div>
    </div>
  <% end %>
</div>
