<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Barquettes & Coefficient</h1>
  <%= link_to 'Nouvelle barquette', new_tray_size_path, class: 'btn btn-primary' %>
</div>

<div class="card mb-5 shadow-sm">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="bi bi-percent"></i> Coefficient multiplicateur</h5>
  </div>
  <div class="card-body">
    <p>
      Ce coefficient est appliqué au coût/kg matière pour
      obtenir le prix de vente conseillé. La barquette est ajoutée après application du coefficient.
    </p>
    <div class="row g-4 align-items-stretch">
      <div class="col-md-5">
        <div class="bg-light rounded border p-3 h-100 d-flex flex-column justify-content-center text-center">
          <small class="text-muted text-uppercase">Formule prix conseillé</small>
          <div class="fw-bold mt-2">(Coût/kg × coeff) + barquette</div>
          <hr>
          <small class="text-muted">
            Exemple avec 5,00 €/kg :
            <br>
            <span class="text-success fw-bold">
              <%= number_with_precision(5.0 * current_user.markup_coefficient, precision: 2) %> €/kg
            </span>
            <br>
            (hors barquette)
          </small>
        </div>
      </div>
      <div class="col-md-7">
        <%= form_with url: settings_path, method: :patch do |f| %>
          <label class="form-label fw-semibold">Coefficient actuel</label>
          <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text">×</span>
            <%= number_field_tag 'user[markup_coefficient]', current_user.markup_coefficient,
                step: 0.1, min: 0.1, class: 'form-control fs-5 fw-bold' %>
            <%= f.submit 'Enregistrer', class: 'btn btn-primary' %>
          </div>
          <div class="form-text">Minimum : 0.1 · Défaut : 1.0</div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<h5 class="mb-3"><i class="bi bi-archive"></i> Barquettes plastique</h5>

<% if @tray_sizes.empty? %>
  <p class="text-muted">Aucune barquette pour le moment.</p>
<% else %>
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prix</th>
        <th>Recettes associées</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @tray_sizes.each do |tray_size| %>
        <tr>
          <td><%= tray_size.name %></td>
          <td><%= number_with_precision(tray_size.price, precision: 2) %> €</td>
          <td><span class="badge bg-secondary"><%= tray_size.recipes_count %></span></td>
          <td class="d-flex gap-1">
            <%= link_to 'Modifier', edit_tray_size_path(tray_size), class: 'btn btn-sm btn-outline-primary' %>
            <% if tray_size.recipes_count > 0 %>
              <%= button_to 'Supprimer', tray_size_path(tray_size), method: :delete,
                    data: { turbo_confirm: "Cette barquette est utilisée dans #{tray_size.recipes_count} recette(s). Les recettes concernées perdront leur barquette. Continuer ?" },
                    class: 'btn btn-sm btn-outline-danger' %>
            <% else %>
              <%= button_to 'Supprimer', tray_size_path(tray_size), method: :delete,
                    data: { turbo_confirm: "Supprimer la barquette « #{tray_size.name} » ?" },
                    class: 'btn btn-sm btn-outline-danger' %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
