<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><%= link_to "Accueil", root_path %></li>
    <li class="breadcrumb-item"><%= link_to "Référentiel Produits", products_path %></li>
    <li class="breadcrumb-item active"><%= @product.name %></li>
  </ol>
</nav>

<!-- En-tête -->
<div class="row mb-4">
  <div class="col-md-8">
    <h2><i class="bi bi-box-seam"></i> <%= @product.name %></h2>
    <div class="d-flex gap-2 mt-2">
      <span class="badge bg-info"><i class="bi bi-clock"></i> Créé le <%= l(@product.created_at, format: :long) %></span>
      <% if @product.updated_at != @product.created_at %>
        <span class="badge bg-secondary"><i class="bi bi-pencil"></i> Modifié le <%= l(@product.updated_at, format: :long) %></span>
      <% end %>
    </div>
  </div>
  <div class="col-md-4 text-end">
    <div class="btn-group" role="group">
      <%= link_to edit_product_path(@product), class: "btn btn-primary" do %>
        <i class="bi bi-pencil"></i> Modifier
      <% end %>
      <%= button_to product_path(@product),
          method: :delete,
          class: "btn btn-danger",
          form: { data: { turbo_confirm: "Êtes-vous sûr de vouloir supprimer ce produit ?" } } do %>
        <i class="bi bi-trash"></i> Supprimer
      <% end %>
    </div>
  </div>
</div>

<div class="row">
  <!-- Colonne gauche : Informations -->
  <div class="col-md-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
          <span class="text-muted">Prix moyen / kg</span>
          <strong class="text-primary fs-4"><%= number_to_currency(@product.avg_price_per_kg, unit: "€", format: "%n %u") %></strong>
        </div>
        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
          <span class="text-muted">Unité de base</span>
          <strong>
            <span class="badge bg-info"><%= @product.base_unit %></span>
          </strong>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Utilisé dans</span>
          <strong><%= @product.recipe_components.count %> recette(s)</strong>
        </div>
      </div>
    </div>

    <%= link_to products_path, class: "btn btn-outline-secondary w-100" do %>
      <i class="bi bi-arrow-left"></i> Retour à la liste
    <% end %>
  </div>

  <!-- Colonne droite -->
  <div class="col-md-8">
    <!-- Conditionnements d'achat -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-cart"></i> Conditionnements d'achat</h5>
      </div>
      <div class="card-body">
        <% if @suppliers.empty? %>
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle"></i>
            Aucun fournisseur actif.
            <%= link_to "Créer un fournisseur", new_supplier_path, class: "alert-link" %> pour pouvoir ajouter des achats.
          </div>
        <% else %>
          <!-- Formulaire inline d'ajout d'achat -->
          <%= form_with(model: [@product, @product_purchase], local: true) do |f| %>
            <div class="row g-2 mb-3">
              <div class="col-md-3">
                <label class="form-label fw-bold">Fournisseur <span class="text-danger">*</span></label>
                <%= f.select :supplier_id,
                    options_for_select(@suppliers.map { |s| [s.name, s.id] }),
                    { prompt: "-- Fournisseur --" },
                    class: "form-select", required: true %>
              </div>
              <div class="col-md-2">
                <label class="form-label fw-bold">Quantité <span class="text-danger">*</span></label>
                <%= f.number_field :package_quantity,
                    class: "form-control",
                    placeholder: "0.00",
                    step: "0.01",
                    min: "0.01",
                    required: true %>
              </div>
              <div class="col-md-2">
                <label class="form-label fw-bold">Unité <span class="text-danger">*</span></label>
                <%= f.select :package_unit,
                    options_for_select([["kg", "kg"], ["g", "g"], ["l", "l"], ["cl", "cl"], ["ml", "ml"], ["pièce", "piece"]]),
                    {},
                    class: "form-select", required: true %>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">Prix <span class="text-danger">*</span></label>
                <div class="input-group">
                  <%= f.number_field :package_price,
                      class: "form-control",
                      placeholder: "0.00",
                      step: "0.01",
                      min: "0",
                      required: true %>
                  <span class="input-group-text">&euro;</span>
                </div>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <%= f.submit "Ajouter", class: "btn btn-primary w-100" %>
              </div>
            </div>
          <% end %>
        <% end %>

        <!-- Tableau des achats existants -->
        <% purchases = @product.product_purchases.includes(:supplier).order(created_at: :desc) %>
        <% if purchases.any? %>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Fournisseur</th>
                  <th class="text-center">Conditionnement</th>
                  <th class="text-end">Prix</th>
                  <th class="text-end">Prix / kg</th>
                  <th class="text-center">Statut</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% purchases.each do |pp| %>
                  <tr class="<%= 'table-secondary' unless pp.active? %>">
                    <td><strong><%= pp.supplier.name %></strong></td>
                    <td class="text-center">
                      <span class="badge bg-light text-dark">
                        <%= number_with_precision(pp.package_quantity, precision: 2) %> <%= pp.package_unit %>
                      </span>
                    </td>
                    <td class="text-end">
                      <%= number_to_currency(pp.package_price, unit: "\u20AC", format: "%n %u") %>
                    </td>
                    <td class="text-end">
                      <strong class="text-primary">
                        <%= number_to_currency(pp.price_per_kg, unit: "\u20AC", format: "%n %u") %> / kg
                      </strong>
                    </td>
                    <td class="text-center">
                      <% if pp.active? %>
                        <span class="badge bg-success">Actif</span>
                      <% else %>
                        <span class="badge bg-warning text-dark">Inactif</span>
                      <% end %>
                    </td>
                    <td class="text-end">
                      <%= button_to toggle_active_product_product_purchase_path(@product, pp),
                          method: :patch,
                          class: "btn btn-sm btn-outline-warning",
                          title: pp.active? ? "Désactiver" : "Réactiver" do %>
                        <i class="bi bi-<%= pp.active? ? 'pause-circle' : 'play-circle' %>"></i>
                      <% end %>
                      <%= button_to product_product_purchase_path(@product, pp),
                          method: :delete,
                          class: "btn btn-sm btn-outline-danger",
                          title: "Supprimer",
                          form: { data: { turbo_confirm: "Supprimer cet achat ? Les prix seront recalculés." } } do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Recettes utilisant ce produit -->
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-journal-text"></i> Recettes utilisant ce produit</h5>
      </div>
      <div class="card-body">
        <% if @product.recipe_components.any? %>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Recette</th>
                  <th class="text-center">Quantité utilisée</th>
                  <th class="text-end">Coût dans la recette</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% @product.recipe_components.includes(:parent_recipe).each do |rc| %>
                  <tr>
                    <td><strong><%= rc.parent_recipe.name %></strong></td>
                    <td class="text-center">
                      <span class="badge bg-light text-dark">
                        <%= number_with_precision(rc.quantity_kg, precision: 3) %> <%= @product.base_unit %>
                      </span>
                    </td>
                    <td class="text-end">
                      <strong class="text-primary">
                        <%= number_to_currency(rc.line_cost, unit: "€", format: "%n %u") %>
                      </strong>
                    </td>
                    <td class="text-end">
                      <%= link_to recipe_path(rc.parent_recipe), class: "btn btn-sm btn-outline-primary" do %>
                        <i class="bi bi-eye"></i>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-4">
            <p class="text-muted mb-0">
              <i class="bi bi-info-circle"></i> Ce produit n'est utilisé dans aucune recette pour le moment.
            </p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
