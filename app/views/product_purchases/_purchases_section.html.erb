<div class="section-card" style="margin-top: 4px;">

  <%# Alert D14: avg_price_per_kg == 0 %>
  <% if product.avg_price_per_kg.to_f == 0 %>
    <div style="background: #fef3c7; border-bottom: 1px solid #fde68a; padding: 8px 16px; font-size: 12px; color: #92400e;">
      <i class="bi bi-exclamation-triangle"></i>
      Aucun achat actif — le prix moyen pondéré est à 0.
    </div>
  <% end %>

  <%# Header: title + avg price badge %>
  <div class="section-header">
    <h2 class="section-title">Conditionnements</h2>
    <span class="mono" style="color: var(--cc-success); font-size: 11px; font-weight: 600;">
      Prix moy: <%= number_with_precision(product.avg_price_per_kg, precision: 2) %> €/kg
    </span>
  </div>

  <%# Existing purchases table %>
  <% if purchases.any? %>
    <table class="data-table">
      <thead>
        <tr>
          <th>Fournisseur</th>
          <th>Qté</th>
          <th>Unité</th>
          <th>Prix HT</th>
          <th>€/kg</th>
          <th>Statut</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% purchases.each do |purchase| %>
          <%= turbo_frame_tag "purchase_#{purchase.id}" do %>
            <%# Display row %>
            <tr style="<%= 'opacity: 0.45;' unless purchase.active? %>">
              <td><%= purchase.supplier.name %></td>
              <td><span class="mono"><%= number_with_precision(purchase.package_quantity, precision: 3, strip_insignificant_zeros: true) %></span></td>
              <td><span class="mono"><%= purchase.package_unit %></span></td>
              <td><span class="mono"><%= number_with_precision(purchase.package_price, precision: 2) %> €</span></td>
              <td><span class="mono"><%= number_with_precision(purchase.price_per_kg, precision: 2) %> €/kg</span></td>
              <td>
                <% if purchase.active? %>
                  <span class="badge-produit">Actif</span>
                <% else %>
                  <span style="background: var(--sl-200); color: var(--sl-500); padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; letter-spacing: 0.04em;">Inactif</span>
                <% end %>
              </td>
              <td>
                <div class="row-actions" style="opacity: 1;">
                  <%# Toggle edit inline %>
                  <%= link_to "#",
                        class: "action-btn",
                        title: "Modifier",
                        data: { controller: "toggle-edit",
                                action: "click->toggle-edit#toggle",
                                toggle_edit_target_param: "edit_purchase_#{purchase.id}" } do %>
                    <i class="bi bi-pencil"></i>
                  <% end %>

                  <%# Toggle active/inactive %>
                  <%= button_to toggle_active_product_purchase_path(purchase),
                        method: :post,
                        params: { product_id: product.id },
                        form: { data: { turbo_frame: "purchases_#{product.id}" } },
                        class: "action-btn",
                        title: purchase.active? ? "Désactiver" : "Activer" do %>
                    <i class="bi bi-<%= purchase.active? ? 'pause-circle' : 'play-circle' %>"></i>
                  <% end %>

                  <%# Delete %>
                  <%= button_to product_purchase_path(purchase),
                        method: :delete,
                        params: { product_id: product.id },
                        form: { data: { turbo_confirm: "Supprimer ce conditionnement ?",
                                        turbo_frame: "purchases_#{product.id}" } },
                        class: "action-btn danger",
                        title: "Supprimer" do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                </div>
              </td>
            </tr>

            <%# Inline edit row (hidden by default) %>
            <tr id="edit_purchase_<%= purchase.id %>" class="d-none">
              <td colspan="7" style="background: var(--sl-50); padding: 12px 16px;">
                <%= form_with url: product_purchase_path(purchase),
                              scope: :product_purchase,
                              method: :patch do |f| %>
                  <%= hidden_field_tag :product_id, product.id %>
                  <% edit_suppliers_json = suppliers.map { |s| { id: s.id, name: s.name } }.to_json %>
                  <div class="form-row" style="grid-template-columns: 1fr 1fr auto 1fr auto auto;"
                       data-controller="supplier-search"
                       data-supplier-search-suppliers-value="<%= edit_suppliers_json %>"
                       data-supplier-search-selected-value="<%= purchase.supplier_id %>">
                    <div style="position: relative;">
                      <label class="form-label-xs">Fournisseur</label>
                      <input type="text"
                             class="form-control form-control-sm"
                             style="font-size: 12px;"
                             value="<%= purchase.supplier.name %>"
                             autocomplete="off"
                             data-supplier-search-target="input"
                             data-action="input->supplier-search#search focus->supplier-search#focus">
                      <input type="hidden"
                             name="product_purchase[supplier_id]"
                             value="<%= purchase.supplier_id %>"
                             data-supplier-search-target="hidden">
                      <div class="search-results-dropdown" style="display: none; position: absolute; z-index: 10; width: 100%; margin-top: 2px;"
                           data-supplier-search-target="results">
                      </div>
                    </div>
                    <div>
                      <label class="form-label-xs">Quantité</label>
                      <%= f.number_field :package_quantity,
                            value: purchase.package_quantity,
                            step: "0.001", min: "0.001",
                            class: "form-control form-control-sm", style: "font-size: 12px;" %>
                    </div>
                    <div>
                      <label class="form-label-xs">Unité</label>
                      <%= f.select :package_unit,
                            Units::VALID_UNITS,
                            { selected: purchase.package_unit },
                            class: "form-select form-select-sm", style: "font-size: 12px;" %>
                    </div>
                    <div>
                      <label class="form-label-xs">Prix HT</label>
                      <%= f.number_field :package_price,
                            value: purchase.package_price,
                            step: "0.01", min: "0",
                            class: "form-control form-control-sm", style: "font-size: 12px;" %>
                    </div>
                    <div style="align-self: end;">
                      <%= f.submit "Enregistrer", class: "btn-slate" %>
                    </div>
                    <div style="align-self: end;">
                      <button type="button"
                              class="btn-outline-slate"
                              onclick="document.getElementById('edit_purchase_<%= purchase.id %>').classList.add('d-none')">
                        Annuler
                      </button>
                    </div>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p style="padding: 16px; color: var(--sl-400); font-size: 12px; margin: 0;">Aucun conditionnement pour le moment.</p>
  <% end %>

  <%# Add purchase form %>
  <div style="padding: 16px;">
    <div class="add-component-form">
      <div style="margin-bottom: 10px;">
        <span class="form-label-xs" style="margin-bottom: 0;">Ajouter un conditionnement</span>
      </div>

      <%= form_with url: product_purchases_path,
                    scope: :product_purchase,
                    data: { turbo_frame: "purchases_#{product.id}" } do |f| %>
        <%= hidden_field_tag :product_id, product.id %>
        <% suppliers_json = suppliers.map { |s| { id: s.id, name: s.name } }.to_json %>
        <div class="form-row" style="grid-template-columns: 1fr 1fr auto 1fr auto;"
             data-controller="supplier-search"
             data-supplier-search-suppliers-value="<%= suppliers_json %>">
          <div style="position: relative;">
            <label class="form-label-xs">Fournisseur</label>
            <input type="text"
                   class="form-control form-control-sm"
                   style="font-size: 12px;"
                   placeholder="Rechercher..."
                   autocomplete="off"
                   data-supplier-search-target="input"
                   data-action="input->supplier-search#search focus->supplier-search#focus">
            <input type="hidden"
                   name="product_purchase[supplier_id]"
                   data-supplier-search-target="hidden">
            <div class="search-results-dropdown" style="display: none; position: absolute; z-index: 10; width: 100%; margin-top: 2px;"
                 data-supplier-search-target="results">
            </div>
          </div>
          <div>
            <label class="form-label-xs">Quantité</label>
            <%= f.number_field :package_quantity,
                  placeholder: "0.000",
                  step: "0.001", min: "0.001",
                  class: "form-control form-control-sm", style: "font-size: 12px;" %>
          </div>
          <div>
            <label class="form-label-xs">Unité</label>
            <%= f.select :package_unit,
                  Units::VALID_UNITS,
                  { include_blank: false },
                  class: "form-select form-select-sm", style: "font-size: 12px;" %>
          </div>
          <div>
            <label class="form-label-xs">Prix HT (€)</label>
            <%= f.number_field :package_price,
                  placeholder: "0.00",
                  step: "0.01", min: "0",
                  class: "form-control form-control-sm", style: "font-size: 12px;" %>
          </div>
          <div style="align-self: end;">
            <%= f.submit "Ajouter", class: "btn-slate" %>
          </div>
        </div>

        <%# New purchase errors %>
        <% if new_purchase.errors.any? %>
          <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 4px; padding: 8px 12px; margin-top: 10px; font-size: 12px; color: var(--cc-danger);">
            <% new_purchase.errors.full_messages.each do |msg| %>
              <div><i class="bi bi-x-circle"></i> <%= msg %></div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

</div>
