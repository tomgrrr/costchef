<div class="bg-light p-3 rounded border mt-1">

  <%# Alerte D14 : avg_price_per_kg == 0 %>
  <% if product.avg_price_per_kg.to_f == 0 %>
    <div class="alert alert-warning py-2 mb-3">
      <i class="bi bi-exclamation-triangle"></i>
      Aucun achat actif — le prix moyen pondéré est à 0.
    </div>
  <% end %>

  <%# Titre + badge prix moyen %>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0 fw-bold">Conditionnements</h6>
    <span class="badge bg-primary">
      Prix moy: <%= number_with_precision(product.avg_price_per_kg, precision: 2) %> €/kg
    </span>
  </div>

  <%# Tableau des conditionnements existants %>
  <% if purchases.any? %>
    <div class="table-responsive mb-3">
      <table class="table table-sm table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Fournisseur</th>
            <th>Qté</th>
            <th>Unité</th>
            <th>Prix HT</th>
            <th>€/kg</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% purchases.each do |purchase| %>
            <%= turbo_frame_tag "purchase_#{purchase.id}" do %>
              <%# Ligne affichage normal %>
              <tr class="<%= 'opacity-50' unless purchase.active? %>">
                <td><%= purchase.supplier.name %></td>
                <td><%= number_with_precision(purchase.package_quantity, precision: 3, strip_insignificant_zeros: true) %></td>
                <td><%= purchase.package_unit %></td>
                <td><%= number_with_precision(purchase.package_price, precision: 2) %> €</td>
                <td><%= number_with_precision(purchase.price_per_kg, precision: 2) %> €/kg</td>
                <td>
                  <% if purchase.active? %>
                    <span class="badge bg-success">Actif</span>
                  <% else %>
                    <span class="badge bg-secondary">Inactif</span>
                  <% end %>
                </td>
                <td>
                  <div class="d-flex gap-1 flex-wrap">
                    <%# Toggle edit inline via Turbo Frame %>
                    <%= link_to "#",
                          class: "btn btn-sm btn-outline-secondary",
                          data: { controller: "toggle-edit",
                                  action: "click->toggle-edit#toggle",
                                  toggle_edit_target_param: "edit_purchase_#{purchase.id}" } do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>

                    <%# Toggle actif/inactif %>
                    <%= button_to purchase.active? ? "Désactiver" : "Activer",
                          toggle_active_product_purchase_path(purchase),
                          method: :post,
                          params: { product_id: product.id },
                          class: "btn btn-sm #{purchase.active? ? 'btn-warning' : 'btn-success'}" %>

                    <%# Supprimer %>
                    <%= button_to product_purchase_path(purchase),
                          method: :delete,
                          params: { product_id: product.id },
                          form: { data: { turbo_confirm: "Supprimer ce conditionnement ?" } },
                          class: "btn btn-sm btn-outline-danger" do %>
                      <i class="bi bi-trash"></i>
                    <% end %>
                  </div>
                </td>
              </tr>

              <%# Ligne formulaire édition inline (cachée par défaut) %>
              <tr id="edit_purchase_<%= purchase.id %>" class="d-none bg-white">
                <td colspan="7">
                  <%= form_with url: product_purchase_path(purchase),
                                scope: :product_purchase,
                                method: :patch,
                                class: "p-2" do |f| %>
                    <%= hidden_field_tag :product_id, product.id %>
                    <div class="row g-2 align-items-end">
                      <div class="col-md-2">
                        <%= f.select :supplier_id,
                              suppliers.pluck(:name, :id),
                              { selected: purchase.supplier_id },
                              class: "form-select form-select-sm" %>
                      </div>
                      <div class="col-md-2">
                        <%= f.number_field :package_quantity,
                              value: purchase.package_quantity,
                              step: "0.001", min: "0.001",
                              placeholder: "Quantité",
                              class: "form-control form-control-sm" %>
                      </div>
                      <div class="col-md-1">
                        <%= f.select :package_unit,
                              Units::VALID_UNITS,
                              { selected: purchase.package_unit },
                              class: "form-select form-select-sm" %>
                      </div>
                      <div class="col-md-2">
                        <%= f.number_field :package_price,
                              value: purchase.package_price,
                              step: "0.01", min: "0",
                              placeholder: "Prix HT",
                              class: "form-control form-control-sm" %>
                      </div>
                      <div class="col-md-auto d-flex gap-1">
                        <%= f.submit "Enregistrer", class: "btn btn-sm btn-primary" %>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                onclick="document.getElementById('edit_purchase_<%= purchase.id %>').classList.add('d-none')">
                          Annuler
                        </button>
                      </div>
                    </div>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-muted mb-3">Aucun conditionnement pour le moment.</p>
  <% end %>

  <hr>

  <%# Formulaire ajout toujours visible %>
  <h6 class="fw-bold mb-2">Ajouter un conditionnement</h6>
  <%= form_with url: product_purchases_path,
                scope: :product_purchase,
                data: { turbo_frame: "purchases_#{product.id}" } do |f| %>
    <%= hidden_field_tag :product_id, product.id %>
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <%= f.select :supplier_id,
              suppliers.pluck(:name, :id),
              { include_blank: "-- Fournisseur --" },
              class: "form-select form-select-sm" %>
      </div>
      <div class="col-md-2">
        <%= f.number_field :package_quantity,
              placeholder: "Quantité",
              step: "0.001", min: "0.001",
              class: "form-control form-control-sm" %>
      </div>
      <div class="col-md-1">
        <%= f.select :package_unit,
              Units::VALID_UNITS,
              { include_blank: false },
              class: "form-select form-select-sm" %>
      </div>
      <div class="col-md-2">
        <%= f.number_field :package_price,
              placeholder: "Prix HT (€)",
              step: "0.01", min: "0",
              class: "form-control form-control-sm" %>
      </div>
      <div class="col-md-auto">
        <%= f.submit "Ajouter", class: "btn btn-sm btn-primary" %>
      </div>
    </div>

    <%# Affichage erreurs du nouveau conditionnement %>
    <% if new_purchase.errors.any? %>
      <div class="alert alert-danger mt-2 py-2">
        <% new_purchase.errors.full_messages.each do |msg| %>
          <div><i class="bi bi-x-circle"></i> <%= msg %></div>
        <% end %>
      </div>
    <% end %>
  <% end %>

</div>
