<%# Page header %>
<div class="page-header">
  <div class="d-flex align-items-center gap-3">
    <h1 class="page-title"><%= @recipe.name %></h1>
    <% if @recipe.subrecipe? %>
      <span class="badge-sous-recette">Sous-recette</span>
    <% end %>
  </div>
  <div class="d-flex gap-2">
    <%= link_to recipes_path, class: "btn-outline-slate" do %>
      <i class="bi bi-arrow-left"></i> Retour
    <% end %>
    <%= button_to duplicate_recipe_path(@recipe),
          method: :post,
          class: "btn-outline-slate",
          form: { data: { turbo_confirm: "Dupliquer cette recette ?" } } do %>
      <i class="bi bi-copy"></i> Dupliquer
    <% end %>
    <%= link_to edit_recipe_path(@recipe), class: "btn-outline-slate" do %>
      <i class="bi bi-pencil"></i> Modifier
    <% end %>
    <%# TODO: Réactiver les boutons convertir recette/sous-recette %>
    <% if false # masqué temporairement %>
      <% if @recipe.subrecipe? %>
        <%= button_to recipe_path(@recipe),
              method: :patch,
              params: { recipe: { sellable_as_component: false } },
              class: "btn-slate",
              form: { data: { turbo_confirm: "Convertir en recette ?" } } do %>
          <i class="bi bi-arrow-up-circle"></i> Convertir en recette
        <% end %>
      <% else %>
        <%= button_to recipe_path(@recipe),
              method: :patch,
              params: { recipe: { sellable_as_component: true, has_tray: false, tray_size_id: "" } },
              class: "btn-slate",
              form: { data: { turbo_confirm: "Convertir en sous-recette ?" } } do %>
          <i class="bi bi-arrow-down-circle"></i> Convertir en sous-recette
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<%# Two-column layout %>
<div class="recipe-layout">
  <%# Main column %>
  <div class="recipe-main">
    <%# Components section %>
    <div class="section-card">
      <div class="section-header">
        <h2 class="section-title">Composants</h2>
      </div>
      <div>
        <%= render "recipes/components_list", recipe: @recipe %>
      </div>
    </div>

    <%# Add component section %>
    <div class="section-card">
      <div class="section-header">
        <h2 class="section-title">Ajouter un composant</h2>
      </div>
      <div style="padding: 16px;">
        <%= render "recipe_components/form",
              recipe: @recipe,
              component: @recipe.recipe_components.build,
              available_products: current_user.products.order(:name),
              available_subrecipes: current_user.recipes
                                                .usable_as_subrecipe
                                                .where.not(id: @recipe.id)
                                                .order(:name) %>
      </div>
    </div>
  </div>

  <%# Sidebar %>
  <div class="recipe-sidebar">
    <%= render "recipes/recipe_summary", recipe: @recipe %>

    <%# Informations section %>
    <div class="sidebar-section">
      <div class="sidebar-label">Informations</div>

      <% if @recipe.description.present? %>
        <p style="font-size: 12px; color: var(--sl-600); margin-bottom: 12px;"><%= @recipe.description %></p>
      <% end %>

      <div class="info-grid">
        <%= render "recipes/cooking_loss_form", recipe: @recipe %>

        <div class="info-row">
          <span class="info-label">Sous-recette</span>
          <span class="info-value">
            <% if @recipe.sellable_as_component? %>
              <span class="badge-sous-recette">Oui</span>
            <% else %>
              Non
            <% end %>
          </span>
        </div>

        <% unless @recipe.subrecipe? %>
          <div class="info-row">
            <span class="info-label">Barquette</span>
            <span class="info-value">
              <% if @recipe.has_tray? %>
                Oui<% if @recipe.tray_size %> — <%= @recipe.tray_size.name %><% end %>
              <% else %>
                Non
              <% end %>
            </span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
