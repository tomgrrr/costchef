<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><%= link_to "Accueil", root_path %></li>
    <li class="breadcrumb-item"><%= link_to "Recettes", recipes_path %></li>
    <li class="breadcrumb-item active"><%= @recipe.name %></li>
  </ol>
</nav>

<!-- En-tête -->
<div class="row mb-4">
  <div class="col-md-8">
    <h2><i class="bi bi-journal-text"></i> <%= @recipe.name %></h2>
    <% if @recipe.description.present? %>
      <p class="text-muted mb-3"><%= @recipe.description %></p>
    <% end %>
    <div class="d-flex gap-2">
      <span class="badge bg-info"><i class="bi bi-clock"></i> Créée le <%= l(@recipe.created_at, format: :short) %></span>
      <% if @recipe.updated_at != @recipe.created_at %>
        <span class="badge bg-secondary"><i class="bi bi-pencil"></i> Modifiée le <%= l(@recipe.updated_at, format: :short) %></span>
      <% end %>
    </div>
  </div>
  <div class="col-md-4 text-end">
    <div class="btn-group" role="group">
      <%= link_to edit_recipe_path(@recipe), class: "btn btn-primary" do %>
        <i class="bi bi-pencil"></i> Modifier
      <% end %>
      <%= button_to duplicate_recipe_path(@recipe), method: :post, class: "btn btn-info" do %>
        <i class="bi bi-files"></i> Dupliquer
      <% end %>
      <%= button_to recipe_path(@recipe),
          method: :delete,
          class: "btn btn-danger",
          form: { data: { turbo_confirm: "Êtes-vous sûr de vouloir supprimer cette recette ?" } } do %>
        <i class="bi bi-trash"></i> Supprimer
      <% end %>
    </div>
  </div>
</div>

<div class="row">
  <!-- Colonne gauche : Résumé des calculs -->
  <div class="col-md-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-calculator"></i> Coût Matière</h5>
      </div>
      <div class="card-body text-center">
        <% if @recipe.cached_total_cost.present? && @recipe.cached_total_cost > 0 %>
          <div class="display-3 text-success fw-bold mb-2">
            <%= number_to_currency(@recipe.cached_total_cost, unit: "€", format: "%n %u") %>
          </div>
          <p class="text-muted mb-0">Prix total des ingrédients</p>
        <% else %>
          <div class="display-5 text-muted mb-2">-</div>
          <p class="text-muted mb-0">Ajoutez des ingrédients</p>
        <% end %>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informations</h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
          <span class="text-muted">Nombre d'ingrédients</span>
          <strong><%= @recipe.recipe_components.count %></strong>
        </div>
        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
          <span class="text-muted">Poids total</span>
          <strong>
            <% if @recipe.cached_total_weight.present? && @recipe.cached_total_weight > 0 %>
              <%= number_with_precision(@recipe.cached_total_weight, precision: 3) %> kg
            <% else %>
              -
            <% end %>
          </strong>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted fw-bold">Coût au kilo</span>
          <strong class="text-primary fs-5">
            <% if @recipe.cached_cost_per_kg.present? && @recipe.cached_cost_per_kg > 0 %>
              <%= number_to_currency(@recipe.cached_cost_per_kg, unit: "€", format: "%n %u") %> / kg
            <% else %>
              -
            <% end %>
          </strong>
        </div>
      </div>
    </div>

    <div class="alert alert-info" role="alert">
      <i class="bi bi-lightbulb"></i>
      <strong>Astuce :</strong> Les prix sont automatiquement mis à jour quand vous modifiez votre référentiel produits.
    </div>

    <%= link_to recipes_path, class: "btn btn-outline-secondary w-100" do %>
      <i class="bi bi-arrow-left"></i> Retour à la liste
    <% end %>
  </div>

  <!-- Colonne droite : Détails des ingrédients -->
  <div class="col-md-8">
    <!-- Formulaire d'ajout d'ingrédient -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Ajouter un ingrédient</h6>
      </div>
      <div class="card-body">
        <% if @available_products.empty? && @available_subrecipes.empty? %>
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle"></i>
            Vous n'avez pas encore de produits dans votre référentiel.
            <%= link_to "Créer un produit", new_product_path, class: "alert-link" %> pour pouvoir ajouter des ingrédients.
          </div>
        <% else %>
          <%= form_with url: recipe_recipe_components_path(@recipe), scope: :recipe_component, method: :post, local: true do |f| %>
            <div class="row g-3">
              <!-- Sélection du composant (produit ou sous-recette) -->
              <div class="col-md-6">
                <label class="form-label fw-bold">Ingrédient <span class="text-danger">*</span></label>
                <select name="recipe_component[component_id]" id="recipe_component_component_id" class="form-select" required
                        data-controller="component-select" data-action="change->component-select#updateType">
                  <option value="">-- Sélectionnez un ingrédient --</option>
                  <% if @available_products.any? %>
                    <optgroup label="Produits">
                      <% @available_products.each do |p| %>
                        <option value="<%= p.id %>" data-type="Product">
                          <%= p.name %> - <%= number_to_currency(p.avg_price_per_kg, unit: '€', format: '%n %u') %> / <%= p.base_unit %>
                        </option>
                      <% end %>
                    </optgroup>
                  <% end %>
                  <% if @available_subrecipes.any? %>
                    <optgroup label="Sous-recettes">
                      <% @available_subrecipes.each do |r| %>
                        <option value="<%= r.id %>" data-type="Recipe">
                          <%= r.name %> - <%= number_to_currency(r.cached_cost_per_kg || 0, unit: '€', format: '%n %u') %> / kg
                        </option>
                      <% end %>
                    </optgroup>
                  <% end %>
                </select>
                <%= f.hidden_field :component_type, value: "Product", data: { "component-select-target": "typeField" } %>
              </div>

              <!-- Quantité -->
              <div class="col-md-4">
                <label class="form-label fw-bold">Quantité <span class="text-danger">*</span></label>
                <%= f.number_field :quantity_kg,
                    class: "form-control",
                    placeholder: "0.000",
                    step: "0.001",
                    min: "0.001",
                    required: true %>
                <small class="form-text text-muted">kg / L / pièce</small>
              </div>

              <!-- Bouton ajouter -->
              <div class="col-md-2 d-flex align-items-end">
                <%= f.submit "Ajouter", class: "btn btn-primary w-100" %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Liste des ingrédients -->
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-list-check"></i> Composition détaillée</h5>
      </div>
      <div class="card-body">
        <% if @recipe.recipe_components.empty? %>
          <div class="text-center py-4">
            <i class="bi bi-basket text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3 mb-0">
              Aucun ingrédient pour le moment. Utilisez le formulaire ci-dessus pour ajouter des ingrédients.
            </p>
          </div>
        <% else %>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 40%">Ingrédient</th>
                  <th style="width: 15%" class="text-center">Quantité</th>
                  <th style="width: 20%" class="text-center">Prix unitaire</th>
                  <th style="width: 20%" class="text-end">Coût</th>
                  <th style="width: 5%"></th>
                </tr>
              </thead>
              <tbody>
                <% @recipe.recipe_components.includes(:component).each do |rc| %>
                  <tr>
                    <td>
                      <strong><%= rc.component.name %></strong>
                      <% if rc.product_component? %>
                        <br><small class="text-muted">Produit</small>
                      <% else %>
                        <br><small class="text-muted"><i class="bi bi-journal-text"></i> Sous-recette</small>
                      <% end %>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-light text-dark">
                        <%= number_with_precision(rc.quantity_kg, precision: 3) %> <%= rc.product_component? ? rc.component.base_unit : 'kg' %>
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="badge bg-secondary">
                        <% if rc.product_component? %>
                          <%= number_to_currency(rc.component.avg_price_per_kg, unit: "€", format: "%n %u") %> / <%= rc.component.base_unit %>
                        <% else %>
                          <%= number_to_currency(rc.component.cached_cost_per_kg || 0, unit: "€", format: "%n %u") %> / kg
                        <% end %>
                      </span>
                    </td>
                    <td class="text-end">
                      <strong class="text-primary fs-5">
                        <%= number_to_currency(rc.line_cost, unit: "€", format: "%n %u") %>
                      </strong>
                    </td>
                    <td class="text-center">
                      <%= button_to recipe_recipe_component_path(@recipe, rc),
                          method: :delete,
                          class: "btn btn-sm btn-outline-danger",
                          title: "Supprimer",
                          form: { data: { turbo_confirm: "Retirer cet ingrédient de la recette ?" } } do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot class="table-success">
                <tr class="fw-bold">
                  <td colspan="3" class="text-end fs-5">TOTAL COÛT MATIÈRE</td>
                  <td class="text-end fs-4 text-success">
                    <%= number_to_currency(@recipe.cached_total_cost || 0, unit: "€", format: "%n %u") %>
                  </td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="alert alert-warning mt-3" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Info :</strong> Les prix sont automatiquement récupérés depuis votre référentiel produits.
            Si un prix change, cette recette sera recalculée automatiquement.
          </div>
        <% end %>
      </div>
    </div>

    <!-- Actions rapides -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
      <%= link_to recipes_path, class: "btn btn-outline-secondary" do %>
        <i class="bi bi-arrow-left"></i> Retour à la liste
      <% end %>
      <%= link_to edit_recipe_path(@recipe), class: "btn btn-primary" do %>
        <i class="bi bi-pencil"></i> Modifier cette recette
      <% end %>
    </div>
  </div>
</div>
