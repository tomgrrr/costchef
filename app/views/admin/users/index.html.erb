<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Gestion des utilisateurs</h1>
    <div>
      <%= link_to "Invitations", admin_invitations_path, class: "btn btn-outline-primary" %>
      <%= link_to "Retour", root_path, class: "btn btn-outline-secondary ms-2" %>
    </div>
  </div>

  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
  <% end %>

  <% if flash[:alert] %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= flash[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
    </div>
  <% end %>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Email</th>
            <th>Entreprise</th>
            <th class="text-center">Abonnement</th>
            <th>Date début</th>
            <th>Date expiration</th>
            <th class="text-center">Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @users.each do |user| %>
            <tr>
              <td><%= user.email %></td>
              <td><%= user.company_name || "-" %></td>
              <td class="text-center">
                <% if user.subscription_active? %>
                  <span class="badge bg-success">Actif</span>
                <% else %>
                  <span class="badge bg-secondary">Inactif</span>
                <% end %>
              </td>
              <td><%= user.subscription_started_at&.strftime("%d/%m/%Y") || "-" %></td>
              <td><%= user.subscription_expires_at&.strftime("%d/%m/%Y") || "-" %></td>
              <td class="text-center">
                <% if user.admin? %>
                  <span class="badge bg-primary">Admin</span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <button type="button" class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#userModal<%= user.id %>">
                  Modifier
                </button>
              </td>
            </tr>

            <!-- Modal pour modifier l'abonnement -->
            <div class="modal fade" id="userModal<%= user.id %>" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <%= form_with model: [:admin, user], local: true do |f| %>
                    <div class="modal-header">
                      <h5 class="modal-title">Modifier l'abonnement</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>
                    <div class="modal-body">
                      <p class="text-muted mb-3"><strong>Utilisateur :</strong> <%= user.email %></p>

                      <div class="mb-3">
                        <div class="form-check form-switch">
                          <%= f.check_box :subscription_active, class: "form-check-input", role: "switch" %>
                          <%= f.label :subscription_active, "Abonnement actif", class: "form-check-label" %>
                        </div>
                      </div>

                      <div class="mb-3">
                        <%= f.label :subscription_started_at, "Date de début", class: "form-label" %>
                        <%= f.date_field :subscription_started_at, class: "form-control" %>
                      </div>

                      <div class="mb-3">
                        <%= f.label :subscription_expires_at, "Date d'expiration", class: "form-label" %>
                        <%= f.date_field :subscription_expires_at, class: "form-control" %>
                      </div>

                      <div class="mb-3">
                        <%= f.label :subscription_notes, "Notes", class: "form-label" %>
                        <%= f.text_area :subscription_notes, class: "form-control", rows: 3 %>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                      <%= f.submit "Enregistrer", class: "btn btn-primary" %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <p class="text-muted mt-3">
    <small><%= @users.count %> utilisateur(s) au total</small>
  </p>
</div>
